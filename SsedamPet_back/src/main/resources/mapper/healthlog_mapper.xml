<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.korit.ssedampet_back.mapper.HealthLogMapper">
    
    <resultMap id="HealthLogResultMap" type="com.korit.ssedampet_back.dto.response.healthlog.HealthLogRespDto">
        <id property="healthLogId" column="healthlog_id" />
        <result property="petId" column="pet_id" />
        <result property="wrtieDate" column="write_date" />
        <result property="waterStatus" column="water_status" />
        <result property="foodStatus" column="food_status" />
        <result property="poopCnt" column="poop_cnt" />
        <result property="symptom" column="symptom" />
        <result property="healthLogMemo" column="healthlog_memo" />
        <result property="createdDt" column="created_dt" />
        <result property="updateDt" column="updated_dt" />
    </resultMap>


<!--    특정 펫, 날짜 기록 조회-->
    <select id="findByPetIdAndDate" resultType="com.korit.ssedampet_back.dto.response.healthlog.HealthLogRespDto">
        select
            healthlog_Id,
            pet_id,
            write_date,
            water_status,
            food_status,
            poop_cnt,
            symptom,
            healthlog_memo,
            created_dt,
            updated_dt
        from
            healthlog_tb
        where
            pet_id = #{petId}
            AND write_date = #{writeDate}
        limit 1
    </select>

<!--    기록 작성 -->
    <insert id="createHealthLog">
        insert into
            healthlog_tb (
        pet_id, write_date, water_status, food_status, poop_cnt, symptom,
        healthlog_memo, created_dt, updated_dt
        ) values (
        #{petId}, #{writeDate}, #{waterStatus}, #{foodStatus}, #{poopCnt}, #{symptom},
        #{healthlogMemo}, now(), now()
        )
    </insert>

<!--    기록 수정 -->
    <update id="updateHealthLog">
        update
            healthlog_tb
        set
            water_status = #{waterStatus},
            food_status = #{foodStatus},
            poop_cnt = #{poopCnt},
            symptom = #{symptom},
            healthlog_memo = #{healthlogMemo},
            updated_dt = NOW()
        where
            healthlog_id = #{healthlogId}
    </update>

<!--    주간 평균 비교 -->
    <select id="getWeeklyAverage" resultType="com.korit.ssedampet_back.dto.response.healthlog.HealthWeeklyAvgDto">
        select
            AVG(poop_cnt) as avgPoopCnt,
            -- 상태값을 점수로 변환하여 평균 산출 (매우좋음: 3, 보통: 2, 나쁨: 1)
            AVG(CASE
                WHEN water_status = '"매우 좋음"' THEN 3
                WHEN water_status = '"보통"' THEN 2
                ELSE 1 END)
                AS avgWaterScore,
            AVG(CASE
                WHEN food_status = '"평소보다 많이 먹음"' THEN 3
                WHEN food_status = '"평소와 같음"' THEN 2
                ELSE 1 END)
                AS avgFoodScore
        from
            healthlog_tb
        where
            petId = #{petId}
            and write_date BETWEEN #{startDate} AND #{endDate}
    </select>

</mapper>