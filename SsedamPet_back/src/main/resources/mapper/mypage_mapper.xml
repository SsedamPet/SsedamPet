<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.ssedampet_back.mapper.MypageMapper">


    <resultMap id="UserDtoMap" type="com.korit.ssedampet_back.dto.response.mypage.UserDto">
        <id     property="userId"            column="user_id"/>
        <result property="name"          column="name"/>
        <result property="email"             column="email"/>
        <result property="userProfileImgUrl" column="user_profile_img_url"/>
    </resultMap>

    <resultMap id="PetDtoMap" type="com.korit.ssedampet_back.dto.response.mypage.PetDto">
        <id     property="petId"            column="pet_id"/>
        <result property="userId"           column="user_id"/>               <!-- (선택) 필요하면 -->
        <result property="petType"          column="pet_type"/>              <!-- ✅ 추가 -->
        <result property="petName"          column="pet_name"/>
        <result property="petBirth"         column="pet_birth"/>             <!-- ✅ 추가 -->
        <result property="petGender"        column="pet_gender"/>
        <result property="petBreed"         column="pet_breed"/>             <!-- ✅ 추가 -->
        <result property="petWeight"        column="pet_weight"/>            <!-- (선택) 필요하면 -->
        <result property="petProfileImgUrl" column="pet_profile_img_url"/>
        <result property="petAge"           column="petAge"/>                <!-- ✅ 유지 -->
    </resultMap>


    <resultMap id="PostDtoMap" type="com.korit.ssedampet_back.dto.response.mypage.PostDto">
        <id     property="postId"            column="post_id"/>
        <result property="userId"            column="user_id"/>
        <result property="postImgUrl"        column="post_img_url"/>
        <result property="postContent"       column="post_content"/>
        <result property="postLikeCnt"       column="post_like_cnt"/>
        <result property="postCommentCnt"    column="post_comment_cnt"/>
        <result property="postLocationTag"   column="post_location_tag"/>
        <result property="createdDt"         column="created_dt"/>
        <result property="updatedDt"         column="updated_dt"/>
    </resultMap>

   <!--select-->

    <!-- 유저 1명 조회 -->
    <select id="findMypageUser" resultMap="UserDtoMap">
        select
            user_id,
            name,
            email,
            user_profile_img_url
        from
            user_tb
        where
            user_id = #{userId}
    </select>

    <!-- 전체 유저 목록 -->
    <select id="findAllUsers" resultMap="UserDtoMap">
        select
            user_id,
            name,
            email,
            user_profile_img_url
        from
            user_tb
        order by
            user_id desc
    </select>

    <update id="updatePetProfileImgUrlInt">
        update pet_tb
        set pet_profile_img_url = #{url}
        where pet_id = #{petId}
          and user_id = #{userId}
    </update>


    <!-- 내가 작성한 게시글 수 -->
    <select id="countMyPosts" resultType="int">
        select
            COUNT(*)
        from
            post_tb
        where
            user_id = #{userId}
    </select>

    <!-- 내가 좋아요 누른 게시글 수 -->
    <select id="countMyLikedPosts" resultType="int">
        select
            COUNT(*)
        from
            like_tb
        where
            user_id = #{userId}
    </select>

    <!-- 내 반려동물 목록 -->
    <select id="findMyPets" resultMap="PetDtoMap">
        select
            pet_id               ,
            user_id                 ,
            pet_type               ,
            pet_name               ,
            pet_birth              ,
            pet_gender             ,
            pet_breed               ,
            pet_weight              ,
            pet_profile_img_url     ,
            IFNULL((YEAR(CURDATE()) - YEAR(pet_birth)), 0) AS petAge
        from
            pet_tb
        where
            user_id = #{userId}
        order by pet_id desc
    </select>

    <!--  반려동물 추가  -->
    <insert id="insertPet" parameterType="com.korit.ssedampet_back.dto.request.PetAddReqDto" useGeneratedKeys="true" keyProperty="petId">

    </insert>

    <!-- 내가 작성한 게시글 목록 (myPosts) -->
    <select id="findMyPosts" resultMap="PostDtoMap">
        select
            post_id,
            user_id,
            post_img_url,
            post_content,
            post_like_cnt,
            post_comment_cnt,
            post_location_tag,
            created_dt,
            updated_dt
        from
            post_tb
        where user_id = #{userId}
        order by post_id desc
    </select>

    <!-- 내가 좋아요 누른 게시글 목록 (likedPosts) -->
    <select id="findMyLikedPosts" resultMap="PostDtoMap">
        select
            p.post_id,
            p.user_id,
            p.post_img_url,
            p.post_content,
            p.post_like_cnt,
            p.post_comment_cnt,
            p.post_location_tag,
            p.created_dt,
            p.updated_dt
        from
            like_tb l
            join post_tb p on p.post_id = l.post_id
        where l.user_id = #{userId}
        order by l.like_id desc
    </select>

</mapper>
